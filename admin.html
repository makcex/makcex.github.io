<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Admin</title>
    <style>
       body {
    background: #f0f2f5; /* lembut dan profesional */
    font-family: 'Arial', sans-serif;
    color: #333;
}
.card {
    background: rgba(255,255,255,0.95);
}
button {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.3s;
}
button:hover {
    background: #0056b3;
}

input {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    width: 100%;
    margin-top: 10px;
    box-sizing: border-box;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    padding: 10px;
    text-align: left;
}
tr:nth-child(even) {
    background: #f9f9f9;
}
th {
    background: #007bff;
    color: white;
}
@media (max-width: 768px) {
    .box {
        grid-template-columns: 1fr;
    }
}


        #laporan {
    background: rgba(255, 255, 255, 0.85); /* biar teks terlihat */
    padding: 15px;
    top: 1rem;
    bottom: 0;
    border-radius: 8px;
    max-height: 400px;
    overflow-y: auto;
    color: black; /* teks jelas */
    font-family: Arial, sans-serif;
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.5rem;
}



    </style>
</head>
<body>
    <h1> Admin Dashboard</h1>

    <div class="box">
    <div>
        <h3>Tambah Produk Baru</h3>
        <input type="file" id="img" placeholder="pilih gambar"><hr>
        <input type="text" id="nama" placeholder="nama produk">
        <input type="number" id="harga" placeholder="harga produk">
        <input type="text" id="jenis" placeholder="type produk">
        <input type="number" id="stok" placeholder="jumlah produk">
        <button onclick="tambahProduk()">Simpan</button>
    </div>

    <div>
  <h3>Penjualan Toko (Kasir)</h3>

  <input type="text" id="produkKasir" list="listProduk" placeholder="Ketik nama produk">
<datalist id="listProduk"></datalist>

<input type="number" id="jumlahKasir" placeholder="Jumlah">
<button onclick="tambahKasir()">Tambah</button>


  <div id="listKasir"></div>
  <h4 id="totalKasir">Total: Rp 0</h4>

  <button onclick="bayarKasir()">Bayar</button>
</div>
</div>
<br>
<div id="laporan">
     <button onclick="loadTransaksi()">Lihat Transaksi</button>
<table border="1">
    <thead>
    <tr>
        <th>tanggal</th>
        <th>nama</th>
        <th>items</th>
        <th>total</th>
    </tr>
    </thead>
    <tbody id="laporan1"></tbody>
</table>
</div>

    <script>

function loadTransaksi() {
    fetch('/admin-data?k=abc')
    .then(res => {
        if (!res.ok) throw new Error("Gagal ambil data admin");
        return res.json();
    })
    .then(data => {
         console.log("Data transaksi:", data);
        const container = document.getElementById('laporan1')
        container.innerHTML = ''

        let totalOmzet = 0

        data.forEach(tr => {
            totalOmzet += tr.total

            const tanggal = new Date(tr.tanggal).toLocaleString()
            const items = tr.cart.map(i => `${i.nama} x${i.jumlah}`).join(', ')

            container.innerHTML += `
            <tr>
                <td>${tanggal}</td>
                <td>${tr.user.nama}</td>
                <td>${items}</td>
                <td>Rp ${tr.total.toLocaleString()}</td>
                </tr>
            `
        })

        container.innerHTML += `<h3>Total Omzet: Rp ${totalOmzet.toLocaleString()}</h3>`
    })
    .catch(err => {
        console.error(err)
        alert("Gagal ambil data transaksi")
    })
}


        
    function tambahProduk() {
    const fileInput = document.getElementById('img')

    if (fileInput.files.length === 0) {
        alert('Pilih gambar terlebih dahulu!')
        return
    }

    // 1ï¸âƒ£ Upload gambar
    const formData = new FormData()
    formData.append('img', fileInput.files[0])

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(upload => {
        // 2ï¸âƒ£ Simpan data produk
        const produk = {
            gbr: upload.fileName,
            nama: document.getElementById('nama').value,
            harga: Number(document.getElementById('harga').value),
            jenis: document.getElementById('jenis').value,
            stok: Number(document.getElementById('stok').value)
        }

        return fetch('/products', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(produk)
        })
    })
    .then(res => res.json())
    .then(() => {
        alert('Barang berhasil ditambahkan âœ…')

        document.querySelectorAll('input').forEach(i => i.value = '')
    })
    .catch(err => {
        console.error(err)
        alert('Terjadi error ðŸ˜¢')
    })
}

let kasirCart = []

// load produk ke dropdown
fetch("/products")
.then(res => res.json())
.then(data => {
  semuaProduk = data

  const datalist = document.getElementById("listProduk")
  datalist.innerHTML = ""

  data.forEach(p => {
    datalist.innerHTML += `
      <option value="${p.nama}">
        Stok: ${p.stok}
      </option>
    `
  })
})

// tambah barang ke kasir
function tambahKasir(){
  const namaProduk = document.getElementById("produkKasir").value.trim()
  const jumlah = Number(document.getElementById("jumlahKasir").value)

  if(jumlah <= 0){
    alert("Jumlah tidak valid")
    return
  }

  // cari produk di list resmi
  let produk = semuaProduk.find(p => 
    p.nama.toLowerCase() === namaProduk.toLowerCase()
  )

  let isManual = false

  if(!produk){
    // Produk belum ada â†’ input harga manual
    const hargaDefault = Number(prompt(`Produk "${namaProduk}" belum ada. Masukkan harga:`))
    if(!hargaDefault || hargaDefault <= 0){
      alert("Harga tidak valid")
      return
    }

    produk = {
      id: 'manual_' + Date.now(), // id unik sementara
      nama: namaProduk,
      harga: hargaDefault,
      stok: Infinity // anggap stok tidak terbatas
    }
    isManual = true
  } else if(produk.stok < jumlah){
    alert("Stok tidak cukup")
    return
  }

  // tambah ke kasirCart
  const existing = kasirCart.find(i => i.id === produk.id)
  if(existing){
    existing.jumlah += jumlah
  } else {
    kasirCart.push({
      id: produk.id,
      nama: produk.nama,
      harga: produk.harga,
      jumlah: jumlah,
      manual: isManual // catat kalau produk manual
    })
  }

  // kurangi stok kalau produk resmi
  if(!isManual){
    produk.stok -= jumlah
  }

  renderKasir()
}



// tampilkan list kasir
function renderKasir(){
  const list = document.getElementById("listKasir")
  const totalEl = document.getElementById("totalKasir")

  list.innerHTML = ""

  kasirCart.forEach((i, index) => {
    list.innerHTML += `
      <p>
        ${i.nama} - Rp ${i.harga} x ${i.jumlah}
        <button onclick="hapusKasir(${index})" style="background:red;width:60px;">X</button>
      </p>
    `
  })

  const total = kasirCart.reduce((sum, i) => {
    return sum + i.harga * i.jumlah
  }, 0)

  totalEl.innerText = "Total: Rp " + total.toLocaleString()
}

// hapus item sebelum bayar
function hapusKasir(index){
  kasirCart.splice(index, 1)
  renderKasir()
}

// bayar
function bayarKasir(){

  if(kasirCart.length === 0){
    alert("Belum ada barang")
    return
  }

  fetch("/jual", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ items: kasirCart })
  })
  .then(res => res.json())
  .then(data => {

    if(!data.success){
      alert(data.message)
      return
    }

    alert("Penjualan berhasil. Total: Rp " + data.total.toLocaleString())

    kasirCart = []
    renderKasir()
    location.reload()
  })
}

window.onload = function(){
    loadTransaksi()
}

// otomatis refresh transaksi setiap 5 detik
setInterval(() => {
    loadTransaksi()
}, 10000)


</script>
</body>
</html>